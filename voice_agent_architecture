● Voice Agent Architecture - Comprehensive Overview                                                                                                                                    
                                                                                                                                                                                       
  Architecture Summary                                                                                                                                                                 
                                                                                                                                                                                       
  Your platform implements a sophisticated real-time voice AI system with three voice providers, bidirectional audio streaming, and Cal.com booking integration.                       
                                                                                                                                                                                       
  ---                                                                                                                                                                                  
  Voice Provider Support                                                                                                                                                               
  ┌───────────────────┬──────────────────┬───────────────────────────────┬──────────────┬──────────────────────────────────────────┐                                                   
  │     Provider      │   Audio Format   │            Latency            │ Tool Calling │             Unique Features              │                                                   
  ├───────────────────┼──────────────────┼───────────────────────────────┼──────────────┼──────────────────────────────────────────┤                                                   
  │ OpenAI Realtime   │ g711_ulaw @ 8kHz │ Lowest (native Telnyx format) │ ❌           │ Zero conversion overhead                 │                                                   
  ├───────────────────┼──────────────────┼───────────────────────────────┼──────────────┼──────────────────────────────────────────┤                                                   
  │ Grok (xAI)        │ PCM16 @ 24kHz    │ Medium                        │ ✅           │ Date context, realism cues, web/X search │                                                   
  ├───────────────────┼──────────────────┼───────────────────────────────┼──────────────┼──────────────────────────────────────────┤                                                   
  │ ElevenLabs Hybrid │ ulaw_8000        │ Medium                        │ ✅           │ 100+ premium voices via Grok STT+LLM     │                                                   
  └───────────────────┴──────────────────┴───────────────────────────────┴──────────────┴──────────────────────────────────────────┘                                                   
  Voice Options                                                                                                                                                                        
                                                                                                                                                                                       
  - OpenAI: 12 voices (Marin, Cedar, Alloy, Ash, Ballad, Coral, Echo, Fable, Nova, Onyx, Sage, Shimmer)                                                                                
  - Grok: 5 voices (Ara, Rex, Sal, Eve, Leo) with realism enhancements                                                                                                                 
  - ElevenLabs: 21+ premium expressive voices                                                                                                                                          
                                                                                                                                                                                       
  ---                                                                                                                                                                                  
  Core Features                                                                                                                                                                        
                                                                                                                                                                                       
  ✅ Call Recording                                                                                                                                                                    
                                                                                                                                                                                       
  - Telnyx generates recordings automatically                                                                                                                                          
  - Recording URL stored in Message.recording_url                                                                                                                                      
  - Available after call hangup via webhook                                                                                                                                            
  - Publicly accessible URL for playback                                                                                                                                               
                                                                                                                                                                                       
  ✅ Transcript Logging                                                                                                                                                                
                                                                                                                                                                                       
  - Real-time transcripts captured during calls                                                                                                                                        
  - Stored in Message.transcript field                                                                                                                                                 
  - Both AI and user speech tracked                                                                                                                                                    
  - Full transcript logged at call end via structured logging                                                                                                                          
                                                                                                                                                                                       
  ✅ Turn Detection (VAD)                                                                                                                                                              
                                                                                                                                                                                       
  Configurable per agent:                                                                                                                                                              
  - turn_detection_mode: server_vad or none                                                                                                                                            
  - turn_detection_threshold: 0.5-0.8 (sensitivity)                                                                                                                                    
  - silence_duration_ms: 500-1000ms (pause detection)                                                                                                                                  
  - Prevents talking over, handles natural pauses                                                                                                                                      
                                                                                                                                                                                       
  ✅ Tool Calling (Cal.com Integration)                                                                                                                                                
                                                                                                                                                                                       
  Available on Grok and ElevenLabs:                                                                                                                                                    
  - check_availability(start_date, end_date, timezone) - Query available slots                                                                                                         
  - book_appointment(date, time, email, duration, notes) - Create bookings                                                                                                             
  - Executed in real-time during voice conversation                                                                                                                                    
  - Email validation required for booking                                                                                                                                              
                                                                                                                                                                                       
  ✅ Context Injection                                                                                                                                                                 
                                                                                                                                                                                       
  Automatically injects into AI context:                                                                                                                                               
  - Contact info: name, phone, email, company, status                                                                                                                                  
  - Offer info: name, description, discount type/value, terms                                                                                                                          
  - Timezone: for Cal.com booking accuracy                                                                                                                                             
  - Date context: current date/time (critical for Grok bookings)                                                                                                                       
                                                                                                                                                                                       
  ✅ Initial Greeting System                                                                                                                                                           
                                                                                                                                                                                       
  - Configurable per agent via initial_greeting field                                                                                                                                  
  - Inbound calls: AI greets first                                                                                                                                                     
  - Outbound calls: AI waits for human to speak (more natural)                                                                                                                         
  - Greeting triggered only after Telnyx stream starts                                                                                                                                 
                                                                                                                                                                                       
  ✅ Machine Detection                                                                                                                                                                 
                                                                                                                                                                                       
  - Detects voicemail/answering machines                                                                                                                                               
  - Configurable via enable_machine_detection                                                                                                                                          
  - Results: "human", "machine", "fax", "silence"                                                                                                                                      
  - Auto-hangup on machine detection with SMS fallback                                                                                                                                 
                                                                                                                                                                                       
  ---                                                                                                                                                                                  
  Call Flow Architecture                                                                                                                                                               
                                                                                                                                                                                       
  ┌─────────────┐     ┌─────────────┐     ┌─────────────────┐     ┌─────────────┐                                                                                                      
  │   Caller    │────>│   Telnyx    │────>│  Voice Bridge   │────>│ AI Provider │                                                                                                      
  │  (Phone)    │<────│   (VoIP)    │<────│  (WebSocket)    │<────│  (OpenAI/   │                                                                                                      
  └─────────────┘     └─────────────┘     └─────────────────┘     │  Grok/11L)  │                                                                                                      
                                                                   └─────────────┘                                                                                                     
                                                 │                                                                                                                                     
                                                 ▼                                                                                                                                     
                                          ┌─────────────┐                                                                                                                              
                                          │  Cal.com    │                                                                                                                              
                                          │  (Booking)  │                                                                                                                              
                                          └─────────────┘                                                                                                                              
                                                                                                                                                                                       
  Audio Format Conversion Pipeline                                                                                                                                                     
                                                                                                                                                                                       
  Telnyx (μ-law 8kHz) ──→ PCM16 8kHz ──→ PCM16 24kHz ──→ Grok                                                                                                                          
  Telnyx (μ-law 8kHz) ◄── PCM16 8kHz ◄── PCM16 24kHz ◄── Grok                                                                                                                          
                                                                                                                                                                                       
  Telnyx (μ-law 8kHz) ←──────── Direct ────────────→ OpenAI (zero conversion!)                                                                                                         
  Telnyx (μ-law 8kHz) ←──────── Direct ────────────→ ElevenLabs (zero conversion!)                                                                                                     
                                                                                                                                                                                       
  ---                                                                                                                                                                                  
  API Endpoints                                                                                                                                                                        
                                                                                                                                                                                       
  Agent Management                                                                                                                                                                     
  ┌────────────────┬────────────────────────────────────┬───────────────────────┐                                                                                                      
  │     Method     │              Endpoint              │      Description      │                                                                                                      
  ├────────────────┼────────────────────────────────────┼───────────────────────┤                                                                                                      
  │ GET/POST       │ /workspaces/{id}/agents            │ List/create agents    │                                                                                                      
  ├────────────────┼────────────────────────────────────┼───────────────────────┤                                                                                                      
  │ GET/PUT/DELETE │ /workspaces/{id}/agents/{id}       │ CRUD operations       │                                                                                                      
  ├────────────────┼────────────────────────────────────┼───────────────────────┤                                                                                                      
  │ GET/PUT        │ /workspaces/{id}/agents/{id}/embed │ Embed widget settings │                                                                                                      
  └────────────────┴────────────────────────────────────┴───────────────────────┘                                                                                                      
  Call Management                                                                                                                                                                      
  ┌────────┬────────────────────────────────────┬────────────────────────────────────────────────────┐                                                                                 
  │ Method │              Endpoint              │                    Description                     │                                                                                 
  ├────────┼────────────────────────────────────┼────────────────────────────────────────────────────┤                                                                                 
  │ POST   │ /workspaces/{id}/calls             │ Initiate outbound call                             │                                                                                 
  ├────────┼────────────────────────────────────┼────────────────────────────────────────────────────┤                                                                                 
  │ GET    │ /workspaces/{id}/calls             │ List call history                                  │                                                                                 
  ├────────┼────────────────────────────────────┼────────────────────────────────────────────────────┤                                                                                 
  │ GET    │ /workspaces/{id}/calls/{id}        │ Get call details (duration, recording, transcript) │                                                                                 
  ├────────┼────────────────────────────────────┼────────────────────────────────────────────────────┤                                                                                 
  │ POST   │ /workspaces/{id}/calls/{id}/hangup │ Terminate active call                              │                                                                                 
  └────────┴────────────────────────────────────┴────────────────────────────────────────────────────┘                                                                                 
  WebSocket Endpoints                                                                                                                                                                  
  ┌───────────────────────────────────────┬──────────────────────────────┐                                                                                                             
  │               Endpoint                │         Description          │                                                                                                             
  ├───────────────────────────────────────┼──────────────────────────────┤                                                                                                             
  │ /voice/stream/{call_id}               │ Production call audio bridge │                                                                                                             
  ├───────────────────────────────────────┼──────────────────────────────┤                                                                                                             
  │ /voice/test/{workspace_id}/{agent_id} │ Browser-based agent testing  │                                                                                                             
  └───────────────────────────────────────┴──────────────────────────────┘                                                                                                             
  ---                                                                                                                                                                                  
  Data Models                                                                                                                                                                          
                                                                                                                                                                                       
  Message (Call Records)                                                                                                                                                               
                                                                                                                                                                                       
  id, conversation_id, direction, channel ("voice")                                                                                                                                    
  status: queued → ringing → answered → completed/failed                                                                                                                               
  duration_seconds, recording_url, transcript                                                                                                                                          
  agent_id, is_ai, campaign_id                                                                                                                                                         
                                                                                                                                                                                       
  Agent (Voice Configuration)                                                                                                                                                          
                                                                                                                                                                                       
  voice_provider: "openai" | "grok" | "elevenlabs"                                                                                                                                     
  voice_id, language, system_prompt, temperature                                                                                                                                       
  turn_detection_mode, turn_detection_threshold, silence_duration_ms                                                                                                                   
  initial_greeting, calcom_event_type_id                                                                                                                                               
  enabled_tools: ["book_appointment", "check_availability"]                                                                                                                            
                                                                                                                                                                                       
  ---                                                                                                                                                                                  
  Frontend Capabilities                                                                                                                                                                
                                                                                                                                                                                       
  Agent Configuration UI                                                                                                                                                               
                                                                                                                                                                                       
  - 5-step wizard for agent creation                                                                                                                                                   
  - Pricing tier selection (determines provider, voices, cost)                                                                                                                         
  - Voice testing dialog with real-time WebRTC audio                                                                                                                                   
  - Embed widget generator with code export                                                                                                                                            
                                                                                                                                                                                       
  Testing Features                                                                                                                                                                     
                                                                                                                                                                                       
  - Real-time voice test via WebSocket                                                                                                                                                 
  - Microphone controls (mute/unmute)                                                                                                                                                  
  - Connection status indicators                                                                                                                                                       
  - Audio playback queue management                                                                                                                                                    
                                                                                                                                                                                       
  Embed Widget                                                                                                                                                                         
                                                                                                                                                                                       
  - Script tag or iframe options                                                                                                                                                       
  - Position, theme, color customization                                                                                                                                               
  - Domain allowlist with wildcard support                                                                                                                                             
  - Mode selection: voice/chat/both                                                                                                                                                    
                                                                                                                                                                                       
  ---                                                                                                                                                                                  
  Grok-Specific Enhancements                                                                                                                                                           
                                                                                                                                                                                       
  Realism Cues                                                                                                                                                                         
                                                                                                                                                                                       
  Natural speech markers available in prompts:                                                                                                                                         
  - [whisper] - Confidential moments                                                                                                                                                   
  - [sigh] - Express relief/thoughtfulness                                                                                                                                             
  - [laugh] - React to humor                                                                                                                                                           
  - [pause] - Natural conversation breaks                                                                                                                                              
  - [breath] - Realistic breathing                                                                                                                                                     
                                                                                                                                                                                       
  Built-in Search Tools                                                                                                                                                                
                                                                                                                                                                                       
  - Web Search - Real-time web queries                                                                                                                                                 
  - X/Twitter Search - Social media context                                                                                                                                            
                                                                                                                                                                                       
  Date Context Injection                                                                                                                                                               
                                                                                                                                                                                       
  Mandatory for booking accuracy:                                                                                                                                                      
  TODAY IS: [Day, Month DD, YYYY]                                                                                                                                                      
  CURRENT TIME: [HH:MM AM/PM TZ]                                                                                                                                                       
  THE YEAR IS [YYYY]                                                                                                                                                                   
                                                                                                                                                                                       
  ---                                                                                                                                                                                  
  Campaign Support                                                                                                                                                                     
                                                                                                                                                                                       
  Voice Campaigns with SMS Fallback                                                                                                                                                    
                                                                                                                                                                                       
  - campaign_type: "voice_sms_fallback"                                                                                                                                                
  - Machine detection triggers SMS fallback                                                                                                                                            
  - Call tracking: attempts, answered, no_answer, busy, voicemail                                                                                                                      
  - SMS fallback: template-based or AI-generated                                                                                                                                       
                                                                                                                                                                                       
  ---                                                                                                                                                                                  
  Key Files Reference                                                                                                                                                                  
  ┌──────────────────────┬───────────────────────────────────────────────────┐                                                                                                         
  │      Component       │                     Location                      │                                                                                                         
  ├──────────────────────┼───────────────────────────────────────────────────┤                                                                                                         
  │ Voice Bridge         │ backend/app/websockets/voice_bridge.py            │                                                                                                         
  ├──────────────────────┼───────────────────────────────────────────────────┤                                                                                                         
  │ OpenAI Voice         │ backend/app/services/ai/voice_agent.py            │                                                                                                         
  ├──────────────────────┼───────────────────────────────────────────────────┤                                                                                                         
  │ Grok Voice           │ backend/app/services/ai/grok_voice_agent.py       │                                                                                                         
  ├──────────────────────┼───────────────────────────────────────────────────┤                                                                                                         
  │ ElevenLabs Voice     │ backend/app/services/ai/elevenlabs_voice_agent.py │                                                                                                         
  ├──────────────────────┼───────────────────────────────────────────────────┤                                                                                                         
  │ Telnyx Voice Service │ backend/app/services/telephony/telnyx_voice.py    │                                                                                                         
  ├──────────────────────┼───────────────────────────────────────────────────┤                                                                                                         
  │ Webhooks             │ backend/app/api/webhooks/telnyx.py                │                                                                                                         
  ├──────────────────────┼───────────────────────────────────────────────────┤                                                                                                         
  │ Agent API            │ backend/app/api/v1/agents.py                      │                                                                                                         
  ├──────────────────────┼───────────────────────────────────────────────────┤                                                                                                         
  │ Call API             │ backend/app/api/v1/calls.py                       │                                                                                                         
  ├──────────────────────┼───────────────────────────────────────────────────┤                                                                                                         
  │ Agent Model          │ backend/app/models/agent.py                       │                                                                                                         
  ├──────────────────────┼───────────────────────────────────────────────────┤                                                                                                         
  │ Message Model        │ backend/app/models/conversation.py                │
  